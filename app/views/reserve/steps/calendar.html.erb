<%= render 'shared/card',
  title: '相続手続きの来店予約',
  subtitle: '' do %>

  <div class="space-y-6">
    <!-- 予約カレンダータイトル -->
    <div class="flex flex-col md:flex-row items-center justify-center gap-6 mb-6">
      <div class="hidden md:block flex-shrink-0">
        <%= image_tag 'illustrations/calendar.svg', alt: 'カレンダー', class: 'w-40 h-40', loading: 'lazy' %>
      </div>
      <div class="text-center md:text-left flex-1">
        <h2 class="text-3xl font-bold bg-gradient-to-r from-green-600 to-green-700 bg-clip-text text-transparent pb-2">
          予約カレンダー
        </h2>
        <p class="text-sm text-gray-600 mt-4">
          下記カレンダーの「○」を選択し、ご希望の時間を選択してください。<br>
          ご予約はご相談希望日の4日前までにお申し込みください。<br>
          具体的なご相談内容をフォームにご記入ください。お急ぎのご相談はお電話にてお問い合わせください。
        </p>
        <div class="text-center md:text-left mt-4 text-gray-700">
          <strong><%= @branch.name %></strong>
          <span class="ml-4">TEL:<%= @branch.phone || '04-2957-4361' %></span>
          <span class="ml-4">平日9:00〜17:00</span>
        </div>
      </div>
    </div>

    <!-- カレンダー表示 -->
    <div class="bg-gray-100 rounded-lg shadow p-4 max-w-4xl mx-auto">
      <h3 class="text-xl font-bold text-center mb-4 py-2 bg-gray-200">
        <%= @target_date.strftime('%Y年%-m月') %>
      </h3>

      <!-- カレンダーテーブル -->
      <table class="w-full border-collapse">
        <thead>
          <tr>
            <% %w[月 火 水 木 金 土 日].each do |day| %>
              <th class="border border-gray-300 p-3 text-center font-bold text-white
                <%= if day == '日'
                      'bg-gradient-to-br from-red-500 to-red-600'
                    elsif day == '土'
                      'bg-gradient-to-br from-blue-500 to-blue-600'
                    else
                      'bg-gradient-to-br from-green-600 to-green-700'
                    end %>">
                <%= day %>
              </th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% start_date = @target_date.beginning_of_month.beginning_of_week(:monday) %>
          <% end_date = @target_date.end_of_month.end_of_week(:monday) %>
          <% (start_date..end_date).each_slice(7) do |week| %>
            <tr>
              <% week.each do |date| %>
                <% is_current_month = date.month == @target_date.month %>
                <% is_available = @available_dates[date] %>
                <% holiday_name = @holidays[date] %>
                <% wday = date.wday # 0=日, 1=月, ..., 6=土 %>

                <td class="border border-gray-300 p-3 text-center align-top h-20
                  <%= if !is_current_month
                        'bg-gray-50'
                      elsif wday == 0 || wday == 6 || holiday_name
                        'bg-white'
                      else
                        'bg-white'
                      end %>">

                  <% if is_current_month %>
                    <!-- 日付表示 -->
                    <div class="text-lg font-semibold
                      <%= if holiday_name
                            'text-red-600'
                          elsif wday == 0
                            'text-red-600'
                          elsif wday == 6
                            'text-blue-600'
                          else
                            'text-gray-700'
                          end %>">
                      <%= date.day %>
                    </div>

                    <!-- 祝日名表示 -->
                    <% if holiday_name %>
                      <div class="flex items-center justify-center gap-1 text-xs text-red-600 mb-1">
                        <i class="fas fa-flag"></i>
                        <span><%= holiday_name %></span>
                      </div>
                    <% end %>

                    <!-- 予約可能・不可表示 -->
                    <% if is_available %>
                      <%= link_to reserve_steps_time_selection_path(
                            branch_id: @branch.id,
                            date: date.to_s
                          ),
                          class: "inline-flex items-center justify-center w-12 h-12 bg-gradient-to-br from-green-100 to-green-200 rounded-full hover:scale-125 hover:shadow-lg transition-all" do %>
                        <i class="fas fa-circle-check text-2xl text-green-600" aria-label="予約可能"></i>
                      <% end %>
                    <% else %>
                      <div class="inline-flex items-center justify-center w-12 h-12 bg-gray-100 rounded-full">
                        <i class="fas fa-circle-xmark text-2xl text-gray-400" aria-label="予約不可"></i>
                      </div>
                    <% end %>
                  <% else %>
                    <!-- 当月以外の日付 -->
                    <div class="text-gray-300">
                      <%= date.day %>
                    </div>
                  <% end %>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <!-- 月送りボタン -->
    <div class="flex justify-center gap-4 mt-6">
      <%= link_to reserve_steps_calendar_path(
            branch_id: @branch.id,
            ym: "#{@prev_month.year}-#{@prev_month.month}"
          ),
          class: "px-8 py-3 rounded-full font-medium text-white bg-gradient-to-r from-amber-700 to-amber-800 hover:from-amber-800 hover:to-amber-900 transition-all shadow-lg hover:shadow-xl" do %>
        <i class="fas fa-chevron-left mr-2"></i>
        <%= @prev_month.strftime('%Y年%-m月') %>
      <% end %>

      <%= link_to reserve_steps_calendar_path(
            branch_id: @branch.id,
            ym: "#{@next_month.year}-#{@next_month.month}"
          ),
          class: "px-8 py-3 rounded-full font-medium text-white bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 transition-all shadow-lg hover:shadow-xl" do %>
        <%= @next_month.strftime('%Y年%-m月') %>
        <i class="fas fa-chevron-right ml-2"></i>
      <% end %>
    </div>

    <!-- 戻るボタン -->
    <div class="flex justify-between mt-6">
      <%= link_to '支店選択に戻る',
          reserve_steps_branch_path(area_id: session[:reservation][:area_id]),
          class: 'btn btn-secondary' %>
    </div>
  </div>
<% end %>
