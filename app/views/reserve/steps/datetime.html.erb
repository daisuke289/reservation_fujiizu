<% content_for :title, "日時選択 - 富士伊豆農業協同組合 予約システム" %>

<div class="max-w-6xl mx-auto">
  <!-- 進捗表示 -->
  <div class="mb-8">
    <div class="flex items-center justify-center space-x-4 mb-4">
      <div class="flex items-center">
        <div class="w-10 h-10 bg-green-600 text-white rounded-full flex items-center justify-center font-bold text-lg">✓</div>
        <span class="ml-2 text-lg text-green-600">エリア選択</span>
      </div>
      <div class="w-8 h-1 bg-green-600"></div>
      <div class="flex items-center">
        <div class="w-10 h-10 bg-green-600 text-white rounded-full flex items-center justify-center font-bold text-lg">✓</div>
        <span class="ml-2 text-lg text-green-600">支店選択</span>
      </div>
      <div class="w-8 h-1 bg-green-600"></div>
      <div class="flex items-center">
        <div class="w-10 h-10 bg-green-600 text-white rounded-full flex items-center justify-center font-bold text-lg">3</div>
        <span class="ml-2 text-lg font-semibold text-green-600">日時選択</span>
      </div>
      <div class="w-8 h-1 bg-gray-300"></div>
      <div class="flex items-center">
        <div class="w-10 h-10 bg-gray-300 text-gray-500 rounded-full flex items-center justify-center font-bold text-lg">4</div>
        <span class="ml-2 text-lg text-gray-500">お客様情報</span>
      </div>
    </div>
  </div>

  <!-- 選択された支店表示 -->
  <div class="mb-6">
    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
      <div class="flex items-center">
        <i class="fas fa-building text-green-600 mr-3"></i>
        <span class="text-lg font-semibold text-green-800">選択中の支店: </span>
        <span class="text-lg text-green-700 ml-2"><%= @branch.name %></span>
      </div>
    </div>
  </div>

  <!-- メインコンテンツ -->
  <%= render 'shared/card',
      title: 'ご希望の日時を選択してください',
      subtitle: '直近2週間の空き状況を表示しています（30分刻み）',
      padding: 'lg',
      shadow: 'lg' do %>
    
    <% if @slots_by_date.any? %>
      <!-- デスクトップ表示（横レイアウト） -->
      <div class="hidden lg:block">
        <div class="grid grid-cols-7 gap-4">
          <% @slots_by_date.each do |date, slots| %>
            <div class="bg-gray-50 rounded-lg p-4">
              <!-- 日付ヘッダー -->
              <div class="text-center mb-4 pb-3 border-b border-gray-200">
                <div class="text-lg font-bold text-gray-800">
                  <%= date.strftime('%-m/%-d') %>
                </div>
                <div class="text-sm text-gray-600">
                  <%= %w[日 月 火 水 木 金 土][date.wday] %>
                </div>
              </div>
              
              <!-- 時間スロット -->
              <div class="space-y-2">
                <% slots.each do |slot| %>
                  <%= link_to reserve_steps_next_path(current_step: 'datetime', slot_id: slot.id),
                      data: { turbo_method: :post },
                      class: "block w-full" do %>
                    <div class="bg-white border border-gray-200 rounded-lg p-3 text-center hover:border-green-500 hover:bg-green-50 transition-all duration-200 group">
                      <div class="text-sm font-semibold text-gray-800 group-hover:text-green-800">
                        <%= slot.starts_at.strftime('%H:%M') %>
                      </div>
                      <div class="text-xs text-gray-600 group-hover:text-green-600">
                        残り<%= slot.remaining_capacity %>枠
                      </div>
                    </div>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
      
      <!-- モバイル表示（縦レイアウト） -->
      <div class="lg:hidden">
        <div class="space-y-6">
          <% @slots_by_date.each do |date, slots| %>
            <div class="bg-gray-50 rounded-lg p-4">
              <!-- 日付ヘッダー -->
              <div class="text-center mb-4 pb-3 border-b border-gray-200">
                <div class="text-xl font-bold text-gray-800">
                  <%= date.strftime('%-m月%-d日') %>（<%= %w[日 月 火 水 木 金 土][date.wday] %>）
                </div>
              </div>
              
              <!-- 時間スロット（グリッド表示） -->
              <div class="grid grid-cols-2 gap-3">
                <% slots.each do |slot| %>
                  <%= link_to reserve_steps_next_path(current_step: 'datetime', slot_id: slot.id),
                      data: { turbo_method: :post },
                      class: "block" do %>
                    <div class="bg-white border border-gray-200 rounded-lg p-4 text-center hover:border-green-500 hover:bg-green-50 transition-all duration-200 group">
                      <div class="text-lg font-bold text-gray-800 group-hover:text-green-800 mb-1">
                        <%= slot.starts_at.strftime('%H:%M') %>
                      </div>
                      <div class="text-sm text-gray-600 group-hover:text-green-600">
                        - <%= slot.ends_at.strftime('%H:%M') %>
                      </div>
                      <div class="text-xs text-gray-500 group-hover:text-green-500 mt-2">
                        残り<%= slot.remaining_capacity %>枠
                      </div>
                    </div>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
      
    <% else %>
      <!-- 空きスロットがない場合 -->
      <div class="text-center py-12">
        <i class="fas fa-calendar-times text-4xl text-yellow-500 mb-4"></i>
        <p class="text-xl text-gray-600 mb-6">
          申し訳ございません。<br>
          現在、ご予約可能な時間がありません。
        </p>
        <div class="space-y-4">
          <p class="text-lg text-gray-600">
            別の支店をお選びいただくか、<br>
            しばらく時間をおいてから再度お試しください。
          </p>
          <%= render 'shared/btn',
              text: '支店選択に戻る',
              variant: 'primary',
              size: 'lg',
              url: reserve_steps_branch_path(area_id: @branch.area_id) %>
        </div>
      </div>
    <% end %>
  <% end %>

  <!-- ナビゲーションボタン -->
  <div class="mt-8 flex justify-between">
    <%= render 'shared/btn',
        text: '支店選択に戻る',
        variant: 'outline-secondary',
        size: 'lg',
        url: reserve_steps_branch_path(area_id: @branch.area_id),
        icon: 'fas fa-arrow-left' %>
    
    <%= render 'shared/btn',
        text: 'ホームに戻る',
        variant: 'secondary',
        size: 'lg',
        url: root_path %>
  </div>

  <!-- 注意事項 -->
  <div class="mt-8">
    <%= render 'shared/card',
        title: 'ご予約に関するご注意',
        padding: 'md',
        shadow: 'sm',
        bg_color: 'bg-blue-50' do %>
      <div class="space-y-2 text-sm text-gray-700">
        <div class="flex items-start gap-2">
          <i class="fas fa-info-circle text-blue-600 mt-0.5 flex-shrink-0"></i>
          <p>相談時間は約60分を予定しております。</p>
        </div>
        <div class="flex items-start gap-2">
          <i class="fas fa-clock text-blue-600 mt-0.5 flex-shrink-0"></i>
          <p>ご予約の10分前までにお越しください。</p>
        </div>
        <div class="flex items-start gap-2">
          <i class="fas fa-phone text-blue-600 mt-0.5 flex-shrink-0"></i>
          <p>ご都合が悪くなった場合は、お早めにお電話でご連絡ください。</p>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Font Awesome CDN -->
<% content_for :head do %>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<% end %>