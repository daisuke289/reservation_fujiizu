# Feature Specifications

利用者向け・管理者向け機能の詳細仕様をまとめたドキュメントです。

---

## 概要

富士伊豆農業協同組合の相続相談予約システムは、高齢者向けの来店予約WebアプリケーションとバックオフィスでのA4印刷管理機能を提供します。

**主な機能**:
- 利用者向け: 4ステップWizard形式の予約フロー
- 管理者向け: ダッシュボード、予約管理、支店管理、印刷機能
- 自動化: Slot自動生成、メール送信、定期ジョブ

---

## 利用者向け機能

### 1. 予約フロー（4ステップWizard形式）

#### ステップ1: エリア・支店選択

**エリア選択**
- 8つのエリアから1つを選択
  - 伊豆太陽地区
  - 三島函南地区
  - 伊豆の国地区
  - あいら伊豆地区
  - なんすん地区
  - 御殿場地区
  - 富士地区
  - 富士宮地区
- セッションに選択情報を保存

**支店選択**
- 選択したエリアに属する支店から1つを選択
- 105支店から選択可能
- 各支店の基本情報表示（名前、住所、営業時間）

#### ステップ2: 日時選択（2画面構成）

**カレンダー表示**
- **表示期間**: 今月・来月の2ヶ月のみ
- **月切り替え**: 「今月」「来月」ボタンで切り替え
- **カレンダー形式**: 7列グリッド
  - 日曜日: 赤色表示
  - 土曜日: 青色表示
- **予約可否の視覚表示**
  - ○（緑）: 予約可能
  - ×（赤）: 予約不可
- **予約不可条件**
  - 過去の日付
  - 土日
  - 祝日（holiday_jp gemで判定）
  - 年末年始（12/30-1/3）
  - 予約枠が存在しない日

**時間選択**
- 選択した日付の予約可能時間を表示
- **営業時間**: 9:00-15:00
- **時間枠**: 1時間刻み（6枠/日）
  - 9:00-10:00
  - 10:00-11:00
  - 11:00-12:00
  - 12:00-13:00
  - 13:00-14:00
  - 14:00-15:00
- **残り枠数表示**: 各時間枠の残り定員を表示
- **満員対応**: 満員の枠は選択不可
- **レスポンシブデザイン**
  - デスクトップ: 3列グリッド
  - モバイル: 1列表示

#### ステップ3: 顧客情報入力

**必須項目**
- 氏名
- フリガナ（全角カタカナ）
- 電話番号（10-11桁、ハイフンなし）
- メールアドレス
- 来店人数（1人以上）
- 相談種別（6種類から選択）
  - 住宅ローン相談
  - 資産運用相談
  - 保険相談
  - 農業融資相談
  - カードローン相談
  - その他金融相談
- プライバシーポリシー同意

**任意項目**
- 相談目的（自由記述）
- 備考

#### ステップ4: 予約確認・完了

**確認画面**
- 入力内容の全項目表示
- 予約詳細（支店名、日時、相談種別）
- 修正リンク（各ステップへ戻る）

**予約確定処理**
- トランザクション管理
- 枠の空き再確認（リアルタイム）
- 重複予約チェック（同一電話番号・同一日）
- 楽観的ロックによる競合制御
- メール送信（バックグラウンドジョブ）

**完了画面**
- 受付番号の表示（8桁ゼロパディング）
- 予約詳細の再確認
- 確認メール送信の案内

### 2. バリデーション

**電話番号**
- 形式: 10-11桁の数字のみ（ハイフン不可）
- パターン: `/\A\d{10,11}\z/`
- 同一日の重複予約禁止

**フリガナ**
- 全角カタカナのみ許可
- パターン: `/\A[ァ-ヶー・＝　]+\z/`

**メールアドレス**
- URI::MailTo::EMAIL_REGEXP による検証
- 必須項目

**来店人数**
- 1人以上の整数
- 数値型チェック

**予約枠の残り定員**
- 予約時点での空き状況を確認
- `slot.remaining_capacity >= party_size`
- 楽観的ロックによる競合制御

### 3. メール送信

**確認メール**
- **件名**: `【JAふじ伊豆】ご予約を承りました（受付番号: XXXXXX）`
- **送信先**: 利用者が入力したメールアドレス
- **送信タイミング**: 予約確定後、バックグラウンドで送信
- **内容**
  - 受付番号
  - 予約日時
  - 支店名・住所・電話番号
  - 顧客情報
  - 相談種別
  - 来店人数
  - 相談目的
  - 備考
- **バックグラウンド送信**: GoodJob使用
- **リトライ**: 3回（多項式バックオフ）
- **エラーハンドリング**: 失敗時はログ出力

---

## 管理者向け機能

### 1. 認証

**Basic認証**
- **ユーザー名**: `admin`（環境変数 `BASIC_AUTH_USER` で変更可能）
- **パスワード**: `password`（環境変数 `BASIC_AUTH_PASSWORD` で変更可能）
- **セキュリティ**:
  - `ActiveSupport::SecurityUtils.secure_compare` による定数時間比較
  - タイミング攻撃対策
- **環境**: テスト環境では認証スキップ

### 2. ダッシュボード

**統計情報**
- 本日の予約数
- 翌日の予約数
- 未確認予約数（予約済みステータス）

**クイックリスト**
- 本日の予約一覧（最大10件）
  - 受付番号、氏名、時刻、支店名、ステータス
- 翌日の予約一覧（最大10件）
- 最近の予約（最新5件）

**ナビゲーション**
- 予約一覧への遷移
- 支店管理への遷移
- 印刷画面への遷移

### 3. 予約管理

**一覧表示**
- ページネーション: 20件/ページ（Kaminari使用）
- デフォルトソート: 予約日時降順

**フィルター機能**
- **日付フィルター**
  - 本日
  - 翌日
- **ステータスフィルター**
  - 予約済み（booked）
  - 来店済み（visited）
  - 要フォローアップ（needs_followup）
  - キャンセル（canceled）
- **支店フィルター**: 全支店から選択
- **日付範囲フィルター**: 開始日・終了日で範囲指定

**検索機能**
- 氏名（部分一致、大文字小文字区別なし）
- 電話番号（部分一致）
- ANDロジック（複数条件を同時指定可能）

**詳細表示**
- 受付番号（8桁ゼロパディング）
- 全予約情報の表示
  - 予約日時
  - 支店情報
  - 顧客情報（氏名、フリガナ、電話、メール、来店人数）
  - 相談情報（種別、目的、備考）
  - ステータス
  - 管理者メモ
  - 作成日時・更新日時

**ステータス管理**
- **遷移パターン**
  - 予約済み → 来店済み
  - 予約済み → 要フォローアップ
  - 予約済み → キャンセル（予約枠の開放処理）
  - キャンセル → 予約済み（予約枠の再確保）
- **副作用**
  - キャンセル時: `slot.decrement_booked_count!(party_size)`
  - 再予約時: `slot.increment_booked_count!(party_size)`

**管理者メモ**
- テキストエリアで自由記述
- 内部メモ（利用者には非表示）
- 予約詳細画面で編集可能

### 4. 支店管理

**一覧表示**
- 全105支店の一覧
- エリアでグループ化（8エリア）
- テーブル表示
  - 支店名
  - 住所
  - 電話番号
  - デフォルト定員
  - 編集リンク

**編集機能**
- **編集可能項目**
  - 支店名
  - 住所
  - 電話番号
  - 営業時間
  - デフォルト定員（default_capacity）
- **バリデーション**
  - 支店名: 必須
  - 電話番号: 必須、10-11桁の数字
  - default_capacity: 必須、1以上

**注意事項**
- default_capacityの変更は、変更後に生成される新しいSlotにのみ適用
- 既存のSlotには影響しない（個別編集は将来的な拡張機能）
- 変更完了時にメッセージで明示

### 5. 印刷機能

**印刷レイアウト**
- 日付指定（デフォルト: 当日）
- 支店別グループ化
- A4用紙対応の専用レイアウト（`layout: 'print'`）
- ステータスがアクティブな予約のみ対象（キャンセル除外）
- ソート: 支店名 → 予約時刻

**印刷情報**
- 受付番号
- 予約時刻
- 氏名・フリガナ
- 電話番号
- 相談種別
- 来店人数
- 相談目的
- 備考
- 管理者メモ

**印刷オプション**
- 日付範囲指定
- 支店フィルター
- ステータスフィルター（来店済みのみ、など）

---

## 画面遷移

### 利用者向けフロー

```
TOP (/)
  ↓
エリア選択 (/reserve/steps/area)
  ↓
支店選択 (/reserve/steps/branch?area_id=X)
  ↓
カレンダー表示 (/reserve/steps/calendar?branch_id=X)
  ↓
時間選択 (/reserve/steps/time_selection?date=YYYY-MM-DD)
  ↓
顧客情報入力 (/reserve/steps/customer?slot_id=X)
  ↓
確認画面 (/reserve/confirm)
  ↓
完了画面 (/reserve/complete?id=X)
```

### 管理者向けフロー

```
ログイン (Basic認証)
  ↓
ダッシュボード (/admin/dashboard)
  ├─→ 予約一覧 (/admin/appointments)
  │     ├─→ 予約詳細 (/admin/appointments/:id)
  │     │     └─→ ステータス更新
  │     └─→ フィルター・検索
  ├─→ 支店管理 (/admin/branches)
  │     └─→ 支店編集 (/admin/branches/:id/edit)
  │           └─→ デフォルト定員変更
  └─→ 印刷画面 (/admin/prints)
        └─→ 日付指定印刷
```

---

## メールシステム

### 送信メール種類

**1. 予約確認メール**
- トリガー: 予約確定時
- 送信先: 利用者が入力したメールアドレス
- テンプレート: `app/views/appointment_mailer/confirmed.html.erb`, `confirmed.text.erb`
- 差出人: `no-reply@example.com`（要設定変更）

### バックグラウンド処理

**GoodJob使用**
- ジョブ: `AppointmentMailJob`
- キュー: `:default`
- リトライ: 3回
- バックオフ: 多項式（exponential）

**処理フロー**
```
1. 予約確定
   ↓
2. AppointmentMailJob.perform_later(appointment.id)
   ↓
3. GoodJobがジョブをキューに追加
   ↓
4. GoodJobワーカーが非同期実行
   ↓
5. AppointmentMailer.confirmed(appointment).deliver_now
   ↓
6. 成功/失敗をログ出力
```

### エラーハンドリング

- **送信失敗時**: ログに記録、3回まで自動リトライ
- **3回失敗後**: GoodJobダッシュボードで確認可能
- **再送**: 管理画面から手動再送（将来的な拡張機能）

### ローカライゼーション

- 日本語件名・本文
- 日時フォーマット: `config/locales/ja.yml` で定義
- タイムゾーン: `Asia/Tokyo`

---

## 今後の拡張可能性

### 機能拡張案

**優先度: 高**

1. **SMS通知機能**
   - 予約確定時のSMS送信
   - 前日リマインダー
   - 実装方法: Twilio、AWS SNS

2. **リマインダーメール**
   - 前日の自動メール送信
   - GoodJob cron で実装

3. **個別Slot編集機能**
   - 特定日時の定員を臨時変更
   - 臨時休業日の設定
   - 管理画面から編集

**優先度: 中**

4. **予約変更機能**
   - 利用者による日時変更
   - 変更締切の設定（前日まで、など）
   - メール通知

5. **FullCalendar.js導入**
   - カレンダーUIの強化
   - ドラッグ&ドロップ予約
   - リアルタイム更新

6. **CSVエクスポート**
   - 予約データの一括ダウンロード
   - 統計データの出力
   - 日付範囲・支店・ステータスでフィルター

**優先度: 低**

7. **オンライン相談対応**
   - Zoom/Google Meet連携
   - ビデオ相談枠の設定
   - カレンダー同期

8. **統計レポート機能**
   - 予約数の推移グラフ
   - 相談種別別の集計
   - 支店別の利用状況
   - ダッシュボードに表示

9. **利用者向けマイページ**
   - 予約履歴の確認
   - 会員登録機能
   - ワンクリック予約

### 技術的改善案

**短期的**

1. **Hotwire/Turbo導入**
   - ページ遷移のスムーズ化
   - リアルタイムの空き状況更新
   - Turbo Frames で部分更新

2. **Redis導入**
   - セッション管理の改善
   - キャッシュ戦略の強化
   - リアルタイム空き状況のキャッシュ

**中長期的**

3. **Action Cable**
   - リアルタイム空き状況の同期
   - 複数ユーザー間の競合表示
   - 「あと1枠」の警告表示

4. **REST API化**
   - モバイルアプリ対応
   - 外部システム連携
   - JSON API仕様

5. **他のジョブキューへの移行検討**
   - Sidekiq（高スループット必要時）
   - Solid Queue（Rails 8標準）

### インフラ改善案

1. **CDN導入**
   - CloudFront、Fastly等
   - アセット配信の高速化

2. **読み取りレプリカの導入**
   - PostgreSQL レプリケーション
   - 負荷分散

3. **Auto Scaling設定**
   - アクセス増加時の自動スケール
   - Heroku Autoscaling、AWS ECS

4. **コンテナ化（Docker）**
   - 環境の統一
   - デプロイの高速化
   - Kubernetes対応

---

## 関連ドキュメント

- **システム設計**: [docs/ARCHITECTURE.md](ARCHITECTURE.md) - データモデル、コントローラー構造
- **データベース設計**: [docs/DATABASE.md](DATABASE.md) - ER図、テーブル定義
- **開発ガイド**: [docs/DEVELOPMENT.md](DEVELOPMENT.md) - セットアップ、コマンド、テスト
- **運用ガイド**: [docs/OPERATIONS.md](OPERATIONS.md) - デプロイ、環境変数
- **実装履歴**: [docs/HISTORY.md](HISTORY.md) - Phase 1-5の詳細実装手順
